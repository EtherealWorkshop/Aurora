#!/bin/bash

usage() {
    cat <<EOF
USAGE: $0 <kernver> <optional flags>
--raw        - prints the output as raw hex bytes
--ver=<0/1>  - specifies the kernver struct version to use
--help       - shows this message
KVG was created by kxtzownsu
(made in bash by sophia)
EOF
    exit
}

crc8() {
    local -n bytes=$1
    local crc=0
    for byte in "${bytes[@]}"; do
        crc=$((crc ^ (byte <\< 8)))
        for _ in {1..8}; do
            if ((crc & 0x8000)); then
                crc=$((crc ^ (0x1070 <\< 3)))
            fi
            crc=$((crc <\< 1))
        done
    done
    echo $(( (crc >\> 8) & 0xFF ))
}

convert_to_u32() {
    printf "%d\n" "$1"
}

print_hex() {
    for b in "${buffer[@]}"; do
        printf "%02x " "$b"
    done
    echo
}

[[ "$1" == "--help" || $# -lt 1 ]] && usage

kernver="$1"
shift

if ! [[ "$kernver" =~ ^0x[0-9a-fA-F]+$ ]] && ((${#1} <= 10)) ; then
    echo "$kernver: Invalid kernver. Max 10 Characters, Hex format. [e.g. 0x12345678]" >&2
    exit 1
fi

kvarg=$((kernver))
ver="1"
raw_out=0

for arg in "$@"; do
    case "$arg" in
        --ver=0) ver="0" ;;
        --ver=1) ver="1" ;;
        --raw) raw_out=1 ;;
        *) ;;
    esac
done

if [[ "$ver" != "0" && "$ver" != "1" ]]; then
    echo "Invalid struct version: $ver" >&2
    exit 1
fi

buffer=()

if [[ "$ver" == "0" ]]; then
    structver=0x02
    uid=$((0x4752574c))
    reserved=(0x00 0x00 0x00)
    buffer=(
        $structver
        $(( (uid >\>  0) & 0xFF ))
        $(( (uid >\>  8) & 0xFF ))
        $(( (uid >\> 16) & 0xFF ))
        $(( (uid >\> 24) & 0xFF ))
        $(( (kvarg >\>  0) & 0xFF ))
        $(( (kvarg >\>  8) & 0xFF ))
        $(( (kvarg >\> 16) & 0xFF ))
        $(( (kvarg >\> 24) & 0xFF ))
        "${reserved[@]}"
    )
    crc=$(crc8 buffer)
    buffer+=($crc)
elif [[ "$ver" == "1" ]]; then
    structver=0x10
    structsize=$((3 + 1 + 4 + 32))
    crc8=0
    flags=0x00
    buffer=(
        $structver
        $structsize
        0x00
        $flags
        $(( (kvarg >\>  0) & 0xFF ))
        $(( (kvarg >\>  8) & 0xFF ))
        $(( (kvarg >\> 16) & 0xFF ))
        $(( (kvarg >\> 24) & 0xFF ))
    )
    for _ in $(seq 1 32); do
        buffer+=(0x00)
    done
    crc_input=("${buffer[@]:3}")
    crc=$(crc8 crc_input)
    buffer[2]=$crc
fi

if ((raw_out)); then
    for b in "${buffer[@]}"; do
        printf "\\x%02x" "$b"
    done
else
    print_hex
fi
