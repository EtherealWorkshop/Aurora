#!/bin/bash

source /usr/share/aurora/functions
export TERM=xterm-direct
kvs() {
    while true; do
        read_center -d "Enter Kernver[Max 8 characters after 0x]: 0x" kernver
        mount --bind /mount /mount
        for mnt in /dev /proc /sys; do
            mkdir -p /mount$mnt
            mount --bind "$mnt" "/mount$mnt"
        done
        vercheck=$(chroot /mount tpmc read 0x1008 1 | tr -d '\r\n[:space:]')
        if [[ "$vercheck" == *2 ]]; then
            ver=0
        elif [ "$vercheck" = "10" ]; then
            ver=1
        fi
        if [ ! -n "$ver" ]; then
            echo "$vercheck"
            break
        fi
        echo "Struct ver: $ver" | center
        break=1
        if [[ ! "$ver" =~ ^[0-9A-Fa-f]{8}$ ]]; then
            echo "Invalid Kernver. Maximum 8 characters after 0x [e.g: 0x00000001]" | center
            break=0
            for mnt in /dev /proc /sys; do
                umount "/mount$mnt"
            done
            continue
        fi
        chroot /mount sh -c 'tpmc write 0x1008 $(kvg 0x'"$kernver"' --ver='"$ver"')' >/dev/null || {
            echo "Invalid Kernver. Maximum 8 characters after 0x [e.g: 0x00000001]" | center
            break=0
            for mnt in /dev /proc /sys; do
                umount "/mount$mnt"
            done
            continue
        }
        for mnt in /dev /proc /sys; do
            umount "/mount$mnt"
        done
        kernver=$(printf "%08s" "$kernver" | tr ' ' '0')
        echo "0x$kernver" > /etc/kernverpending
        if [ "$break" = "1" ]; then break; fi
    done
    umount /mount
    sync
}
if [ "$(crossystem mainfw_type)" = "recovery" ]; then
    kvs
else
    echo "Please boot Aurora in recovery [Esc+Ref+Pwr] to use KVS." | center
    read_center "Press Enter to return to the main menu"
fi