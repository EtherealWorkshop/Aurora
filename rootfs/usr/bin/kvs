#!/bin/bash

fail() {
    export errormsg="$1"
	sync
    cd /
    umount /dev/loop*p* 2>/dev/null
    umount /dev/loop* 2>/dev/null
	losetup -D
    for arg in "$@"; do
        if [ "$arg" = "--fatal" ]; then
            echo_c "A fatal error occured. Please Reboot" RED_B | center
            hang
        fi
    done
    return 1
}

hang() {
	tput civis
	stty -echo
	sleep 1h
	echo "You really still haven't turned off your device?" | center
	sleep 1d
	echo "I give up. Bye" | center
	sleep 5
	reboot -f
}

kvs() {
    while true; do
        clear
        read -p "Enter Kernver[Max 8 characters after 0x]: 0x" kernver
        mount --bind /mount /mount
        for mnt in /dev /proc /sys; do
            mkdir -p /mount$mnt
            mount --bind "$mnt" "/mount$mnt"
        done
        vercheck=$(chroot /mount tpmc read 0x1008 1 | tr -d '\r\n[:space:]')
        if [[ "$vercheck" == *2 ]]; then
            ver=0
        elif [ "$vercheck" = "10" ]; then
            ver=1
        fi
        if [ ! -n "$ver" ]; then
            echo "$vercheck"
            break
        fi
        echo "Struct ver: $ver"
        break=1
        chroot /mount sh -c 'tpmc write 0x1008 $(kvg 0x'"$kernver"' --ver='"$ver"')' || {
            echo "Invalid Kernver. Maximum 8 characters after 0x [eg: 0x00000001]"
            break=0
        }
        for mnt in /dev /proc /sys; do
            umount "/mount$mnt"
        done
        if [ "$break" = "1" ]; then break; fi
        echo "0x$kernver" > /etc/kernverpending
    done
    sync
}
if [ "$(crossystem mainfw_type)" = "recovery" ]; then
    kvs
else
    echo "Please boot Aurora in recovery [Esc+Ref+Pwr] to use KVS."
    read -p "Press Enter to return to the main menu"
fi