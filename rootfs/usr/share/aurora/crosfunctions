mount_basics() {
  mountpoint -q /proc || mount -t proc proc /proc
  mountpoint -q /sys  || mount -t sysfs sys /sys
  if ! mountpoint -q /dev; then
    mount -t devtmpfs devtmpfs /dev 2>/dev/null || mount --rbind /dev /dev
    mount --make-rprivate /dev
  fi
}

pivot_cros() {
    mount --make-rprivate /
    mountpoint -q "/usr/share/cros" || mount --bind "/usr/share/cros" "/usr/share/cros"
    mkdir -p "/usr/share/cros/.aurora"
    pivot_root "/usr/share/cros" "/usr/share/cros/.aurora"
    cd /
    mountpoint -q /.aurora || mount --bind /.aurora /.aurora
    mkdir -p /.aurora/.aurora
    mount_basics
}

pivot_aurora() {
    mount --make-rprivate /
    mountpoint -q /.aurora || mount --bind /.aurora /.aurora
    mkdir -p /.aurora/usr/share/cros
    pivot_root /.aurora /.aurora/usr/share/cros
    cd /
    umount -l /usr/share/cros/proc 2>/dev/null
    umount -l /usr/share/cros/sys  2>/dev/null
    mount_basics
}