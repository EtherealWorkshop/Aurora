
mount_basics() {
    if [ -d /.aurora/dev ]; then
        newroot="/usr/share/cros"
    elif [ -d /usr/share/cros/dev ]; then
        newroot="/.aurora"
    else
        return 1
    fi
    for mountpoint in /dev /proc /sys; do
        mkdir -p "${newroot}${mountpoint}"
        mount --move $mountpoint "${newroot}${mountpoint}"
    done
    mount --make-rprivate /dev
}

pivot_cros() {
    mount --make-rprivate /
    mountpoint -q "/usr/share/cros" || mount --bind "/usr/share/cros" "/usr/share/cros"
    mkdir -p "/usr/share/cros/.aurora"
    mount_basics
    pivot_root "/usr/share/cros" "/usr/share/cros/.aurora"
    cd /
    mountpoint -q /.aurora || mount --bind /.aurora /.aurora
    mkdir -p /.aurora/.aurora
}

pivot_aurora() {
    mount --make-rprivate /
    mountpoint -q /.aurora || mount --bind /.aurora /.aurora
    mkdir -p /.aurora/usr/share/cros
    pivot_root /.aurora /.aurora/usr/share/cros
    cd /
    mount_basics
    exec bash /usr/share/aurora/aurora.sh
}