#!/bin/busybox sh

set -e

echo "[init] Mounting Alpine rootfs..."
mkdir -p /newroot
mount -t ext4 /dev/sda4 /newroot

echo "[init] Moving mount points..."
mkdir -p /newroot/{dev,proc,sys}
mount --move /dev  /newroot/dev
mount --move /proc /newroot/proc
mount --move /sys  /newroot/sys

if [ -d /run ]; then
  mkdir -p /newroot/run
  mount --move /run /newroot/run || echo "[warn] /run not moved"
fi

echo "[init] Switching to new root..."
chmod +x /newroot/sbin/init

exec switch_root /newroot /sbin/init || {
  echo "[init] switch_root failed! Dropping to emergency shell..."
  exec /bin/sh
}
