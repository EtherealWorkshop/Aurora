#!/bin/bash

shimbootsizer() {
    aurorapartition=$(lsblk -pro NAME,PARTLABEL | grep -i Aurora | awk '{print $1}')
    if [ -z "$aurorapartition" ]; then
        echo "Aurora partition not found."
        exit 1
    fi

    device=$(echo "$aurorapartition" | sed 's/[0-9]\+$//')

    echo -e "How much space would you like to allocate to Shimboot?\nThis can be changed at any time."
    
    blocksize=$(dumpe2fs -h "$aurorapartition" 2>/dev/null | awk '/Block size:/ {print $3}')
    blockcount=$(dumpe2fs -h "$aurorapartition" 2>/dev/null | awk '/Block count:/ {print $3}')
    oldbytes=$(echo "$blocksize * $blockcount" | bc)
    oldsize_gb=$(echo "scale=2; $oldbytes / 1073741824" | bc)

    echo "Current Aurora partition size: ${oldsize_gb} GB"

    read -p "Enter how much space to remove from Aurora (in GB): " shimbootsize
    shimbootsize=$(echo "$shimbootsize" | sed 's/[^0-9.]//g')

    if [ -z "$shimbootsize" ]; then
        echo "Invalid input."
        exit 1
    fi

    newsize_gb=$(echo "scale=2; $oldsize_gb - $shimbootsize" | bc)
    if (( $(echo "$newsize_gb <= 1" | bc -l) )); then
        echo "Invalid Size."
        exit 1
    fi

    newbytes=$(echo "$newsize_gb * 1073741824" | bc)
    newblocks=$(echo "$newbytes / $blocksize" | bc)

    echo "Shrinking filesystem to $newblocks blocks..."

    e2fsck -f "$aurorapartition" || exit 1
    resize2fs "$aurorapartition" "$newblocks" || exit 1

    parted "$device" resizepart 4 "${newsize_gb}GB" || exit 1
    partprobe "$device"

    e2fsck -f "$aurorapartition" || exit 1
}


read -p "Make/Expand space for shimboot partition? (y/N): " aurorapartitioner
case $aurorapartitioner in
    y|Y) shimbootsizer ;;
    *) ;;
esac
