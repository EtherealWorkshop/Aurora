#!/bin/bash

shrink_filesystem() {
    aurorapartition=$(lsblk -pro NAME,PARTLABEL | grep -i Aurora | awk '{print $1}')
    if [ -z "$aurorapartition" ]; then
        echo "Aurora partition not found."
        exit 1
    fi

    device=$(echo "$aurorapartition" | sed 's/[0-9]\+$//')

    echo -e "How much space would you like to allocate to Shimboot?\nThis can be changed at any time."
    mount "$aurorapartition" /mnt
    freespace=$(df -h "$aurorapartition" | tail -n1 | awk '{print $4}')
    umount "$aurorapartition"
    echo -e "$freespace of free space"
    read -p "Enter size to allocate (in GB): " shimbootsize
    shimbootsize=$(echo "$shimbootsize" | sed 's/[^0-9.]//g')

    if [ -z "$shimbootsize" ]; then
        echo "Invalid input."
        exit 1
    fi

    size=$(dumpe2fs -h "$aurorapartition" 2>/dev/null | awk '/Block size:/ {print $3}')
    blocks=$(dumpe2fs -h "$aurorapartition" 2>/dev/null | awk '/Block count:/ {print $3}')

    if [ -z "$size" ] || [ -z "$blocks" ]; then
        echo "Cannot find block information."
        exit 1
    fi

    newsize=$(( (shimbootsize * 1024 * 1024 * 1024) / size ))
    if (( newsize <= 0 )); then
        echo "Invalid size."
        exit 1
    fi
    e2fsck -f "$aurorapartition"
    resize2fs "$aurorapartition" "$newsize"
}


read -p "Make/Resize Shimboot partition? (y/N): " aurorapartitioner
case $aurorapartitioner in
    y|Y) shimbootsizer ;;
    *) ;;
esac
