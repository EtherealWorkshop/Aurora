#!/bin/busybox sh

export COLOR_RESET="\033[0m"
export BLACK_B="\033[1;30m"
export RED_B="\033[1;31m"
export GEEN="\033[0;32m"
export GEEN_B="\033[1;32m"
export YELLOW="\033[0;33m"
export YELLOW_B="\033[1;33m"
export BLUE_B="\033[1;34m"
export MAGENTA_B="\033[1;35m"
export PINK_B="\x1b[1;38;2;235;170;238m"
export CYAN_B="\033[1;36m"
export PS1='\e[1;34m\]\u@\h \e[1;33m\]$(date +"%H:%M %b %d")\e[1;32m\] \w/\[\e[0m\] '

auroraselected() {
    echo "Moving mounts to /auroraroot"
    mkdir -p "/auroraroot/sys"
    mount -n -o move "/sys" "/auroraroot/sys"
    mkdir -p "/auroraroot/proc"
    mount -n -o move "/proc" "/auroraroot/proc"
    mkdir -p "/auroraroot/dev"
    mount -n -o move "/dev" "/auroraroot/dev"
    mkdir -p /auroraroot/initramfs
    chmod +x /auroraroot/sbin/init
    pivot_root /auroraroot /auroraroot/initramfs
    umount -l /initramfs
    exec /sbin/init < "$TTY1" >> "$TTY1" 2>&1
}

shimbootselected() {
    shimboot_partition=$(blkid | grep 'PARTLABEL="shimboot_rootfs' | awk -F: '{print $1}' | head -n1 || true)
    if [ -n "$shimboot_partition" ]; then
        exec /bootstrap.sh < "$TTY1" >> "$TTY1" 2>&1
    else
        shimdir="/auroraroot/usr/share/aurora/images/shims/"
        i=1

        for shim in "$shimdir"/*.bin; do
            [ -e "$shim" ] || continue
            echo "$i) $(basename "$shim")"
            eval "file_$i=\"\$shim\""
            i=$((i + 1))
        done

        if [ "$i" -eq 1 ]; then
            echo "No shims found."
            rm -f /auroraroot/etc/shimboot
            return 1
        fi

        echo -n "Choose your shimboot shim: "
        read choice

        eval "shim=\$file_$choice"

        if [ -n "$shim" ] && [ -e "$shim" ]; then

            mountpoint -q /auroraroot || mount "$dev_partition" /auroraroot

            a_free_kb=$(df -k /auroraroot | awk 'NR==2 {print $4}')
            a_free_bytes=$((a_free_kb * 1024))
            echo "Available: $(numfmt --to=iec "$a_free_bytes")"
            echo -n "Enter size to allocate to shimboot rootfs [Ex: 1G]: "
            read size

            shimbytes=$(stat -c %s "$shim")
            extrabytes=$(numfmt --from=iec "$size" 2>/dev/null || echo 0)
            totalbytes=$((shimbytes + extrabytes))

            if [ "$totalbytes" -ge "$a_free_bytes" ]; then
                echo "ERROR: Not enough free space in Aurora to shrink by $(numfmt --to=iec "$totalbytes")"
                umount /auroraroot
                return 1
            fi
            if [ "$extrabytes" -le 0 ]; then
                echo "Invalid size."
                return 1
            fi

            totalsectors=$(( (totalbytes + 511) / 512 ))

            aurorainfo=$(sgdisk -i 4 "$dev")
            aurorastart=$(echo "$aurorainfo" | grep "First sector" | awk '{print $3}')
            auroraend=$(echo "$aurorainfo" | grep "Last sector" | awk '{print $3}')
            newauroraend=$((auroraend - totalsectors))
            shimbootpartition_start=$((newauroraend + 1))

            if [ "$newauroraend" -le "$aurorastart" ]; then
                echo "ERROR: Cannot shrink Aurora below minimum size"
                return 1
            fi

            umount /auroraroot || {
                echo "Failed to unmount filesystem"
                return 1
            }
            e2fsck -f "$dev_partition" || {
                echo "Failed to check filesystem"
                return 1
            }
            resize2fs "$dev_partition" $(( (newauroraend - aurorastart + 1) * 512 ))s || {
                echo "Failed to resize filesystem"
                return 1
            }

            sgdisk --delete=4 "$dev"
            sgdisk --new=4:${aurorastart}:${newauroraend} -c 4:"Aurora" "$dev"

            partprobe "$dev"
            sleep 3

            for i in $(seq 1 5); do
                dev_partition=$(blkid | grep 'LABEL="Aurora"' | awk -F: '{print $1}')
                if [ -n "$dev_partition" ] && [ -e "$dev_partition" ]; then break; fi
                sleep 1
            done

            if [ ! -e "$dev_partition" ]; then
                echo "failed to find aurora partition"
                return 1
            fi

            e2fsck -f "$dev_partition" || {
                echo "Failed to check filesystem"
                return 1
            }

            mount "$dev_partition" /auroraroot || {
                echo "Failed to mount filesystem"
                return 1
            }

            sgdisk --new=5:${shimbootpartition_start}:0 --change-name=5:"shimboot_rootfs" "$dev"
            partprobe "$dev"
            sleep 2

            looproot=$(losetup -Pf --show "$shim")
            looprootpart=$(blkid | grep 'PARTLABEL="shimboot_rootfs' | grep "$looproot" | awk -F: '{print $1}' | head -n1 || true)

            mkfs.ext4 "${dev}p5"
            mkdir -p /mnt/shimloop /mnt/newshim
            mount "$looprootpart" /mnt/shimloop
            mount "${dev}p5" /mnt/newshim
            cp -a /mnt/shimloop/. /mnt/newshim/
            umount /mnt/shimloop /mnt/newshim
            losetup -d "$looproot"

            echo "shimboot_rootfs successfully copied to ${dev}p5"
            exec /bootstrap.sh < "$TTY1" >> "$TTY1" 2>&1
        else
            echo "Invalid choice... somehow"
            return 1
        fi
    fi
}

clear
echo "Making the auroraroot partition..."
mkdir -p /auroraroot || sleep 10
dev_partition=$(blkid | grep 'LABEL="Aurora"' | awk -F: '{print $1}' || true)
dev=$(echo "$dev_partition" | sed -E 's/p?[0-9]+$//')
if [ -z "$dev_partition" ]; then
    echo "failed to find aurora partition"
    sleep 5
    exit 1
fi
if [ -f "/.UNRESIZED" ]; then
    chmod +x /.UNRESIZED
    bash /.UNRESIZED
    rm -f /.UNRESIZED
    sync
fi
echo "Mounting device..."
mount $dev_partition /auroraroot
while true; do
    clear
        echo -ne "$BLUE_B"
    cat <<'EOF'
╒════════════════════════════════════════╕
│ .    . .    '    +   *       o    .    │
│+  '.                    '   .-.     +  │
│          +      .    +   .   ) )     ''│
│                   '  .      '-´  *.    │
│     .    \      .     .  .  +          │
│         .-o-'       '    .o        o   │
│  *        \      *            +'       │
│                '       '               │
│        .*       .       o   o      .   │
│              o     . *.                │
│ 'o*           .        .'    .         │
│           ━┳━           ┏━┏━     *     │
│     .*     ┃ ┏┓▪╋┏┓┏┓┏┳┓┣╸┗┓  . \      │
│     o     ━┻━┛┗┻┻┛ ┗┻┛┗┗┛ ━┛     +     │
╘════════════════════════════════════════╛
              Initramfs Menu
EOF
    echo -e "${COLOR_RESET}\n"
    echo -e "1. Aurora (${YELLOW_B}${dev_partition}${COLOR_RESET})"
    echo -e "2. Shimboot (If you have it)"
    echo -e "3. Shell\n"
    echo -ne "${GEEN_B}(initramfs)> ${COLOR_RESET}"
    read initselection
    case $initselection in
        1) auroraselected ;;
        2) shimbootselected || sleep 5 ;;
        3) clear && script -qfc 'stty sane && stty erase '^H' && exec busybox sh -l' /dev/null ;;
        *) echo "Invalid Option" ;;
    esac
done
